<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>è‹±æ–‡å•è¯å¬å†™ - å¬éŸ³å†™å•è¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Comic Sans MS', 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: linear-gradient(135deg, #F5E6F0 0%, #E8DDF0 50%, #F0E6F5 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
            /* å…¼å®¹iOS Safari */
            min-height: -webkit-fill-available;
        }

        .container {
            background: linear-gradient(to bottom, #ffffff 0%, #FAF7FC 100%);
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(200, 150, 200, 0.15);
            max-width: 500px;
            width: 100%;
            height: 100%;
            max-height: -webkit-fill-available;
            overflow: hidden;
            border: 3px solid #E8D5E8;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .header {
            background: linear-gradient(135deg, #D8A8D8 0%, #E8C8E8 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .header::before {
            content: "âœ¨";
            position: absolute;
            left: 20px;
            top: 15px;
            font-size: 24px;
            animation: twinkle 2s infinite;
        }

        .header::after {
            content: "âœ¨";
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            animation: twinkle 2s infinite 1s;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
        }

        .content {
            padding: 20px 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* é¡µé¢åˆ‡æ¢ */
        .page {
            display: none;
        }

        .page.active {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        /* é¦–é¡µæ ·å¼ */
        .unit-selector {
            margin-bottom: 30px;
        }

        .unit-selector label {
            display: block;
            font-size: 16px;
            color: #C89AB8;
            margin-bottom: 16px;
            font-weight: 700;
            text-align: center;
        }

        .unit-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .unit-btn {
            padding: 20px 12px;
            border: 2px solid #E8D5E8;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
            color: #C89AB8;
            box-shadow: 0 4px 15px rgba(200, 154, 184, 0.1);
        }

        .unit-btn:hover {
            border-color: #C89AB8;
            background: #F7F0F7;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(200, 154, 184, 0.15);
        }

        .unit-btn.active {
            background: linear-gradient(135deg, #C89AB8 0%, #D8C5D8 100%);
            color: white;
            border-color: transparent;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(200, 154, 184, 0.2);
        }

        .unit-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 8px;
            animation: bounce 0.6s ease-in-out;
        }

        .unit-btn.active .unit-icon {
            animation: bounce 0.6s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .count-selector {
            margin-bottom: 30px;
        }

        .count-selector label {
            display: block;
            font-size: 16px;
            color: #C89AB8;
            margin-bottom: 16px;
            font-weight: 700;
            text-align: center;
        }

        .count-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        .count-btn {
            padding: 14px;
            border: 2px solid #E8D5E8;
            border-radius: 18px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 700;
            color: #C89AB8;
            box-shadow: 0 4px 15px rgba(200, 154, 184, 0.1);
        }

        .count-btn:hover {
            border-color: #C89AB8;
            background: #F7F0F7;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(200, 154, 184, 0.15);
        }

        .count-btn.active {
            background: linear-gradient(135deg, #C89AB8 0%, #D8C5D8 100%);
            color: white;
            border-color: transparent;
            transform: scale(1.08);
            box-shadow: 0 8px 25px rgba(200, 154, 184, 0.2);
        }

        .start-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #C89AB8 0%, #D8C5D8 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 6px 20px rgba(200, 154, 184, 0.2);
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(200, 154, 184, 0.3);
        }

        .start-btn:active {
            transform: translateY(-1px);
        }

        /* å¬å†™é¡µé¢æ ·å¼ */
        .progress-bar {
            margin-bottom: 30px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
            color: #C89AB8;
            font-weight: 600;
        }

        .progress-fill {
            height: 8px;
            background: #E8E0E8;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill-inner {
            height: 100%;
            background: linear-gradient(90deg, #C89AB8 0%, #D8C5D8 100%);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 10px;
        }

        .word-display {
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .word-number {
            font-size: 14px;
            color: #D8C5D8;
            margin-bottom: 25px;
            font-weight: 600;
        }

        .chinese-word {
            font-size: 56px;
            font-weight: 700;
            color: #C89AB8;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(255, 133, 192, 0.1);
        }

        .phonetic {
            font-size: 16px;
            color: #D8C5D8;
            margin-bottom: 20px;
            font-style: italic;
            font-weight: 500;
        }

        .play-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #C89AB8 0%, #D8C5D8 100%);
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.8);
            font-size: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 8px 30px rgba(200, 154, 184, 0.2);
        }

        .play-btn:hover {
            transform: scale(1.12);
            box-shadow: 0 12px 40px rgba(200, 154, 184, 0.3);
        }

        .play-btn:active {
            transform: scale(0.98);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        /* å€’è®¡æ—¶æ ·å¼ */
        .countdown-container {
            margin-top: 20px;
            text-align: center;
        }

        .countdown-bar {
            height: 6px;
            background: #E8E0E8;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .countdown-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #C89AB8 0%, #D8C5D8 100%);
            width: 100%;
            transition: width 0.1s linear;
            border-radius: 3px;
        }

        .countdown-text {
            font-size: 14px;
            color: #C89AB8;
            font-weight: 600;
        }

        .btn {
            padding: 14px;
            border: 2px solid #E8D5E8;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: white;
            color: #C89AB8;
            border-color: #C89AB8;
            box-shadow: 0 4px 12px rgba(200, 154, 184, 0.1);
        }

        .btn-secondary:hover {
            background: #F7F0F7;
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(200, 154, 184, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #C89AB8 0%, #D8C5D8 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(200, 154, 184, 0.15);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(200, 154, 184, 0.25);
        }

        /* ç»“æœé¡µé¢æ ·å¼ */
        .result-card {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #F7F0F7 0%, #E8DFE8 100%);
            border-radius: 25px;
            border: 2px solid #D8C5D8;
        }

        .result-title {
            font-size: 28px;
            color: #C89AB8;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            padding: 16px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(200, 154, 184, 0.1);
        }

        .stat-label {
            font-size: 12px;
            color: #D8C5D8;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #C89AB8;
        }

        .result-list {
            text-align: left;
            max-height: 320px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 16px;
            border: 1px solid #E8DFE8;
        }

        .result-item {
            padding: 14px;
            border-bottom: 1px solid #E8DFE8;
            font-size: 14px;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-english {
            color: #C89AB8;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .result-phonetic {
            color: #D8C5D8;
            font-size: 12px;
            font-style: italic;
            margin-bottom: 4px;
        }

        .result-chinese {
            color: #666;
            font-weight: 500;
        }

        .button-group-large {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* å•å…ƒè¿›åº¦æ˜¾ç¤º */
        .unit-progress {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .unit-btn.active .unit-progress {
            color: rgba(255,255,255,0.8);
        }

        /* é‡ç½®æŒ‰é’® */
        .reset-btn {
            width: 100%;
            padding: 12px;
            background: white;
            color: #C89AB8;
            border: 2px solid #E8D5E8;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #F7F0F7;
            border-color: #C89AB8;
        }

        /* ç»“æœé¡µä¸ä¼šæŒ‰é’® */
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #E8DFE8;
        }

        .result-item-content {
            flex: 1;
        }

        .mark-unknown-btn {
            padding: 6px 12px;
            background: white;
            color: #C89AB8;
            border: 1px solid #E8D5E8;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .mark-unknown-btn:hover {
            background: #F7F0F7;
            border-color: #C89AB8;
        }

        .mark-unknown-btn.marked {
            background: #FFE5E5;
            color: #E57373;
            border-color: #E57373;
        }

        /* å‰©ä½™æç¤º */
        .remaining-info {
            text-align: center;
            padding: 10px;
            background: #F7F0F7;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #C89AB8;
        }

        .remaining-info.complete {
            background: #E8F5E9;
            color: #4CAF50;
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 15px;
                border-width: 2px;
            }

            .header {
                padding: 12px 10px;
            }

            .header h1 {
                font-size: 18px;
                margin-bottom: 2px;
            }

            .header p {
                font-size: 11px;
            }

            .header::before,
            .header::after {
                font-size: 16px;
                top: 10px;
            }

            .content {
                padding: 10px;
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .progress-bar {
                margin-bottom: 8px;
            }

            .progress-info {
                font-size: 12px;
                margin-bottom: 6px;
            }

            .chinese-word {
                font-size: 38px;
                margin-bottom: 5px;
            }

            .phonetic {
                font-size: 14px;
                margin-bottom: 10px;
            }

            .play-btn {
                width: 70px;
                height: 70px;
                font-size: 35px;
            }

            .result-stats {
                grid-template-columns: 1fr;
            }

            .unit-buttons,
            .count-buttons {
                gap: 10px;
            }

            .unit-btn,
            .count-btn {
                padding: 16px 8px;
                font-size: 12px;
            }

            .start-btn {
                padding: 14px;
                font-size: 16px;
            }

            .btn {
                padding: 8px 5px;
                font-size: 12px;
            }

            .button-group.three-cols {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 6px;
            }

            .word-display {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .word-number {
                font-size: 11px;
                margin-bottom: 5px;
            }

            .countdown-container {
                margin-top: 10px;
            }

            .countdown-text {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è‹±æ–‡å•è¯å¬å†™</h1>
            <p>å¬éŸ³é¢‘ï¼Œç”¨ç¬”å†™å•è¯</p>
        </div>

        <div class="content">
            <!-- é¦–é¡µ -->
            <div id="homePage" class="page active">
                <div class="unit-selector">
                    <label>é€‰æ‹©å­¦ä¹ å•å…ƒ</label>
                    <div class="unit-buttons">
                        <button class="unit-btn active" data-unit="unit1">
                            <span class="unit-icon">ğŸ“š</span>
                            <span>Unit 1</span>
                            <span class="unit-progress" id="progress-unit1">0/0</span>
                        </button>
                        <button class="unit-btn" data-unit="unit2">
                            <span class="unit-icon">ğŸ“–</span>
                            <span>Unit 2</span>
                            <span class="unit-progress" id="progress-unit2">0/0</span>
                        </button>
                        <button class="unit-btn" data-unit="unit3">
                            <span class="unit-icon">âœï¸</span>
                            <span>Unit 3</span>
                            <span class="unit-progress" id="progress-unit3">0/0</span>
                        </button>
                        <button class="unit-btn" data-unit="unit4">
                            <span class="unit-icon">ğŸ“</span>
                            <span>Unit 4</span>
                            <span class="unit-progress" id="progress-unit4">0/0</span>
                        </button>
                    </div>
                </div>

                <div class="remaining-info" id="remainingInfo">å‰©ä½™ 0 ä¸ªå•è¯æœªå­¦ä¹ </div>

                <div class="count-selector">
                    <label>é€‰æ‹©å•è¯æ•°é‡</label>
                    <div class="count-buttons">
                        <button class="count-btn" data-count="5">5ä¸ª</button>
                        <button class="count-btn active" data-count="10">10ä¸ª</button>
                        <button class="count-btn" data-count="15">15ä¸ª</button>
                    </div>
                </div>

                <button class="start-btn" id="startBtn">å¼€å§‹å¬å†™</button>
                <button class="reset-btn" id="resetBtn">é‡ç½®å­¦ä¹ è¿›åº¦</button>
            </div>

            <!-- å¬å†™é¡µé¢ -->
            <div id="dictationPage" class="page">
                <div class="progress-bar">
                    <div class="progress-info">
                        <span id="progressText">1/10</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-fill">
                        <div class="progress-fill-inner" id="progressFill"></div>
                    </div>
                </div>

                <div class="word-display">
                    <div class="word-number" id="wordNumber">ç¬¬ 1 ä¸ªå•è¯</div>
                    <div class="chinese-word" id="chineseWord">å¦ˆå¦ˆ</div>
                    <div class="phonetic" id="phonetic">/ËˆmÊŒÃ°É™r/</div>
                    <button class="play-btn" id="playBtn" title="ç‚¹å‡»æ’­æ”¾å‘éŸ³">ğŸ”Š</button>
                </div>

                <div class="countdown-container">
                    <div class="countdown-bar">
                        <div class="countdown-bar-inner" id="countdownBar"></div>
                    </div>
                    <div class="countdown-text" id="countdownText">15ç§’åè‡ªåŠ¨ä¸‹ä¸€ä¸ª</div>
                </div>

                <div class="button-group three-cols" style="grid-template-columns: 1fr 1fr 1fr;">
                    <button class="btn btn-secondary" id="prevBtn">ä¸Šä¸€ä¸ª</button>
                    <button class="btn btn-secondary" id="homeBtn2" style="background: white; color: #C89AB8; border-color: #C89AB8;">è¿”å›é¦–é¡µ</button>
                    <button class="btn btn-primary" id="nextBtn">ä¸‹ä¸€ä¸ª</button>
                </div>
            </div>

            <!-- ç»“æœé¡µé¢ -->
            <div id="resultPage" class="page">
                <div class="result-card">
                    <div class="result-title">å¬å†™å®Œæˆï¼</div>
                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-label">æ€»å•è¯æ•°</div>
                            <div class="stat-value" id="totalCount">10</div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: #333;">å•è¯æ±‡æ€»</h3>
                <div class="result-list" id="resultList"></div>

                <div class="button-group-large">
                    <button class="btn btn-secondary" id="againBtn">å†æ¥ä¸€æ¬¡</button>
                    <button class="btn btn-primary" id="homeBtn">è¿”å›é¦–é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        let state = {
            selectedUnit: "unit1",
            selectedCount: 10,
            currentWordIndex: 0,
            words: [],
            unitData: {},
            learnedWords: {} // å·²å­¦ä¹ çš„å•è¯ { unit1: ["sun", "moon"], unit2: [...] }
        };

        // localStorage é”®å
        const STORAGE_KEY = "dictation_learned_words";

        // ä»localStorageåŠ è½½å·²å­¦ä¹ çš„å•è¯
        function loadLearnedWords() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    state.learnedWords = JSON.parse(saved);
                } else {
                    state.learnedWords = { unit1: [], unit2: [], unit3: [], unit4: [] };
                }
            } catch (e) {
                console.error("Failed to load learned words:", e);
                state.learnedWords = { unit1: [], unit2: [], unit3: [], unit4: [] };
            }
        }

        // ä¿å­˜å·²å­¦ä¹ çš„å•è¯åˆ°localStorage
        function saveLearnedWords() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.learnedWords));
            } catch (e) {
                console.error("Failed to save learned words:", e);
            }
        }

        // è·å–æŸå•å…ƒæœªå­¦ä¹ çš„å•è¯
        function getUnlearnedWords(unitName) {
            const unitData = state.unitData[unitName];
            if (!unitData || !unitData.words) return [];

            const learned = state.learnedWords[unitName] || [];
            return unitData.words.filter(word => !learned.includes(word.english));
        }

        // æ ‡è®°å•è¯ä¸ºå·²å­¦ä¹ 
        function markAsLearned(unitName, englishWord) {
            if (!state.learnedWords[unitName]) {
                state.learnedWords[unitName] = [];
            }
            if (!state.learnedWords[unitName].includes(englishWord)) {
                state.learnedWords[unitName].push(englishWord);
                saveLearnedWords();
            }
        }

        // æ ‡è®°å•è¯ä¸ºä¸ä¼šï¼ˆä»å·²å­¦ä¹ ä¸­ç§»é™¤ï¼‰
        function markAsUnknown(unitName, englishWord) {
            if (state.learnedWords[unitName]) {
                state.learnedWords[unitName] = state.learnedWords[unitName].filter(w => w !== englishWord);
                saveLearnedWords();
            }
        }

        // é‡ç½®æŸå•å…ƒçš„å­¦ä¹ è¿›åº¦
        function resetUnitProgress(unitName) {
            state.learnedWords[unitName] = [];
            saveLearnedWords();
        }

        // é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦
        function resetAllProgress() {
            state.learnedWords = { unit1: [], unit2: [], unit3: [] };
            saveLearnedWords();
        }

        // æ›´æ–°é¦–é¡µè¿›åº¦æ˜¾ç¤º
        function updateProgressDisplay() {
            ["unit1", "unit2", "unit3", "unit4"].forEach(unitName => {
                const unitData = state.unitData[unitName];
                const total = unitData && unitData.words ? unitData.words.length : 0;
                const learned = state.learnedWords[unitName] ? state.learnedWords[unitName].length : 0;
                const progressEl = document.getElementById(`progress-${unitName}`);
                if (progressEl) {
                    progressEl.textContent = `${learned}/${total}`;
                }
            });
            updateRemainingInfo();
        }

        // æ›´æ–°å‰©ä½™å•è¯æç¤º
        function updateRemainingInfo() {
            const unlearned = getUnlearnedWords(state.selectedUnit);
            const infoEl = document.getElementById("remainingInfo");
            const startBtn = document.getElementById("startBtn");

            if (unlearned.length === 0) {
                infoEl.textContent = "ğŸ‰ æœ¬å•å…ƒå·²å…¨éƒ¨å­¦å®Œï¼";
                infoEl.className = "remaining-info complete";
                startBtn.textContent = "å·²å…¨éƒ¨å­¦å®Œ";
                startBtn.disabled = true;
            } else {
                infoEl.textContent = `å‰©ä½™ ${unlearned.length} ä¸ªå•è¯æœªå­¦ä¹ `;
                infoEl.className = "remaining-info";
                startBtn.disabled = false;
                if (unlearned.length < state.selectedCount) {
                    startBtn.textContent = `å­¦ä¹ å‰©ä½™ ${unlearned.length} ä¸ª`;
                } else {
                    startBtn.textContent = "å¼€å§‹å¬å†™";
                }
            }
        }

        // å€’è®¡æ—¶ç›¸å…³
        const COUNTDOWN_SECONDS = 15;
        let countdownTimer = null;
        let countdownInterval = null;
        let remainingTime = COUNTDOWN_SECONDS;
        let autoPlayEnabled = true; // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ’­æ”¾ï¼ˆ10ç§’ã€5ç§’æ—¶ï¼‰

        // ä»JSONæ–‡ä»¶åŠ è½½å•è¯æ•°æ®
        async function loadUnitData(unitName) {
            try {
                const response = await fetch(`${unitName}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Successfully loaded ${unitName}.json with ${data.words.length} words`);
                return data;
            } catch (error) {
                console.error(`Failed to load ${unitName}.json:`, error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œè¿”å›ç©ºæ•°æ®ç»“æ„ä»¥é¿å…åº”ç”¨å´©æºƒ
                return { id: unitName, name: unitName, words: [] };
            }
        }

        // åˆå§‹åŒ–åŠ è½½æ‰€æœ‰å•å…ƒæ•°æ®
        async function initializeUnits() {
            try {
                state.unitData.unit1 = await loadUnitData("unit1");
                state.unitData.unit2 = await loadUnitData("unit2");
                state.unitData.unit3 = await loadUnitData("unit3");
                state.unitData.unit4 = await loadUnitData("unit4");

                // æ£€æŸ¥æ˜¯å¦æˆåŠŸåŠ è½½
                const loadedUnits = Object.entries(state.unitData)
                    .filter(([key, data]) => data && data.words && data.words.length > 0)
                    .map(([key]) => key);
                console.log("Successfully loaded units:", loadedUnits);

                // å¦‚æœunit1æœ‰æ•°æ®ï¼Œåˆ·æ–°æ˜¾ç¤º
                if (state.unitData.unit1 && state.unitData.unit1.words.length > 0) {
                    console.log("Unit1 data is ready");
                }
            } catch (error) {
                console.error("Error during initialization:", error);
            }
        }

        // DOM å…ƒç´ 
        const pages = {
            home: document.getElementById("homePage"),
            dictation: document.getElementById("dictationPage"),
            result: document.getElementById("resultPage")
        };

        // åˆå§‹åŒ–
        async function init() {
            loadLearnedWords();
            await initializeUnits();
            setupEventListeners();
            updateProgressDisplay();
        }

        // äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // é¦–é¡µ
            document.querySelectorAll(".unit-btn").forEach(btn => {
                btn.addEventListener("click", () => selectUnit(btn.dataset.unit, btn));
            });

            document.querySelectorAll(".count-btn").forEach(btn => {
                btn.addEventListener("click", () => selectCount(btn.dataset.count, btn));
            });

            document.getElementById("startBtn").addEventListener("click", startDictation);
            document.getElementById("resetBtn").addEventListener("click", handleReset);

            // å¬å†™é¡µé¢
            document.getElementById("playBtn").addEventListener("click", playSound);
            document.getElementById("nextBtn").addEventListener("click", nextWord);
            document.getElementById("prevBtn").addEventListener("click", prevWord);
            document.getElementById("homeBtn2").addEventListener("click", goHome);

            // ç»“æœé¡µé¢
            document.getElementById("againBtn").addEventListener("click", startDictation);
            document.getElementById("homeBtn").addEventListener("click", goHome);
        }

        // é‡ç½®è¿›åº¦å¤„ç†
        function handleReset() {
            if (confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦å—ï¼Ÿ")) {
                resetAllProgress();
                updateProgressDisplay();
            }
        }

        // é¦–é¡µé€»è¾‘
        function selectUnit(unit, btn) {
            state.selectedUnit = unit;
            document.querySelectorAll(".unit-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            updateRemainingInfo();
        }

        function selectCount(count, btn) {
            state.selectedCount = parseInt(count);
            updateRemainingInfo();
            document.querySelectorAll(".count-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        }

        // å¼€å§‹å¬å†™
        function startDictation() {
            // è§£é”iOSéŸ³é¢‘ï¼ˆç”¨æˆ·ç‚¹å‡»è§¦å‘ï¼‰
            unlockAudio();

            const unitData = state.unitData[state.selectedUnit];

            console.log("Start dictation with unit:", state.selectedUnit);
            console.log("Unit data:", unitData);

            if (!unitData || !unitData.words || unitData.words.length === 0) {
                alert(`æ— æ³•åŠ è½½ ${state.selectedUnit} çš„å•è¯æ•°æ®ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•`);
                return;
            }

            // è·å–æœªå­¦ä¹ çš„å•è¯
            const unlearnedWords = getUnlearnedWords(state.selectedUnit);
            state.currentWordIndex = 0;

            if (unlearnedWords.length === 0) {
                alert("æœ¬å•å…ƒå·²å…¨éƒ¨å­¦å®Œï¼è¯·é‡ç½®è¿›åº¦åå†è¯•ã€‚");
                return;
            }

            console.log(`Unlearned words: ${unlearnedWords.length}, selected count: ${state.selectedCount}`);

            // éšæœºé€‰æ‹©å•è¯ï¼ˆä»æœªå­¦ä¹ çš„ä¸­é€‰ï¼‰
            const shuffled = [...unlearnedWords].sort(() => Math.random() - 0.5);
            const selectCount = Math.min(state.selectedCount, unlearnedWords.length);
            state.words = shuffled.slice(0, selectCount);

            console.log("Selected words:", state.words);

            showPage("dictation");
            displayWord(0);
        }

        // æ˜¾ç¤ºå•è¯
        function displayWord(index) {
            state.currentWordIndex = index;
            const word = state.words[index];

            document.getElementById("wordNumber").textContent = `ç¬¬ ${index + 1} ä¸ªå•è¯`;
            document.getElementById("chineseWord").textContent = word.chinese;
            document.getElementById("phonetic").textContent = word.phonetic;

            // æ›´æ–°è¿›åº¦
            const progress = ((index + 1) / state.words.length) * 100;
            document.getElementById("progressFill").style.width = progress + "%";
            document.getElementById("progressText").textContent = `${index + 1}/${state.words.length}`;
            document.getElementById("progressPercent").textContent = Math.round(progress) + "%";

            // æ›´æ–°æŒ‰é’®
            document.getElementById("prevBtn").disabled = index === 0;

            // è‡ªåŠ¨æ’­æ”¾ï¼ˆå¼€å§‹æ—¶æ’­æ”¾ä¸€æ¬¡ï¼‰
            setTimeout(() => playSoundAuto(), 300);

            // å¯åŠ¨å€’è®¡æ—¶
            startCountdown();
        }

        // éŸ³é¢‘å¯¹è±¡ï¼ˆå¤ç”¨åŒä¸€ä¸ªå¯¹è±¡ä»¥æ”¯æŒiOSè‡ªåŠ¨æ’­æ”¾ï¼‰
        let audioPlayer = new Audio();
        let audioUnlocked = false;

        // è§£é”iOSéŸ³é¢‘ï¼ˆåœ¨ç”¨æˆ·äº¤äº’æ—¶è°ƒç”¨ï¼‰
        function unlockAudio() {
            if (audioUnlocked) return;
            // æ’­æ”¾ä¸€ä¸ªé™éŸ³æ¥è§£é”
            audioPlayer.src = "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYoRwmHAAAAAAD/+xDEAAPAAAGkAAAAIAAANIAAAARMQU1FMy4xMDBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//sQxBoDwAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV";
            audioPlayer.play().then(() => {
                audioUnlocked = true;
                console.log("Audio unlocked for iOS");
            }).catch(e => {
                console.log("Audio unlock failed:", e);
            });
        }

        // æ’­æ”¾å‘éŸ³ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
        function playSoundCore() {
            if (!state.words || state.words.length === 0) {
                console.error("No words loaded");
                return;
            }

            const word = state.words[state.currentWordIndex];
            if (!word) {
                console.error("Word not found at index", state.currentWordIndex);
                return;
            }

            console.log("Playing word:", word.english);

            // ä½¿ç”¨æœ‰é“è¯å…¸APIæ’­æ”¾å‘éŸ³ï¼ˆç¾éŸ³ï¼‰
            const audioUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(word.english)}&type=1`;

            audioPlayer.src = audioUrl;
            audioPlayer.play().catch(e => {
                console.error("Audio play failed, fallback to speechSynthesis:", e);
                // å¦‚æœæœ‰é“APIå¤±è´¥ï¼Œå›é€€åˆ°æµè§ˆå™¨TTS
                const utterance = new SpeechSynthesisUtterance(word.english);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            });
        }

        // ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾ï¼ˆå–æ¶ˆåç»­è‡ªåŠ¨æ’­æ”¾ï¼‰
        function playSound() {
            autoPlayEnabled = false; // å–æ¶ˆ10ç§’ã€5ç§’çš„è‡ªåŠ¨æ’­æ”¾
            playSoundCore();
        }

        // è‡ªåŠ¨æ’­æ”¾ï¼ˆå¼€å§‹æ—¶ã€10ç§’ã€5ç§’ï¼‰
        function playSoundAuto() {
            playSoundCore();
        }

        // å¯åŠ¨å€’è®¡æ—¶
        function startCountdown() {
            stopCountdown();
            remainingTime = COUNTDOWN_SECONDS;
            autoPlayEnabled = true; // é‡ç½®è‡ªåŠ¨æ’­æ”¾
            let played10 = false;
            let played5 = false;
            updateCountdownDisplay();

            countdownInterval = setInterval(() => {
                remainingTime = Math.round((remainingTime - 0.1) * 10) / 10; // é¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
                updateCountdownDisplay();

                // ç¬¬10ç§’æ—¶æ’­æ”¾è¯­éŸ³ï¼ˆå¦‚æœè‡ªåŠ¨æ’­æ”¾æœªè¢«å–æ¶ˆï¼‰
                if (autoPlayEnabled && !played10 && remainingTime === 10) {
                    played10 = true;
                    playSoundAuto();
                }

                // ç¬¬5ç§’æ—¶æ’­æ”¾è¯­éŸ³ï¼ˆå¦‚æœè‡ªåŠ¨æ’­æ”¾æœªè¢«å–æ¶ˆï¼‰
                if (autoPlayEnabled && !played5 && remainingTime === 5) {
                    played5 = true;
                    playSoundAuto();
                }

                if (remainingTime <= 0) {
                    stopCountdown();
                    nextWord();
                }
            }, 100);
        }

        // åœæ­¢å€’è®¡æ—¶
        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function updateCountdownDisplay() {
            const bar = document.getElementById("countdownBar");
            const text = document.getElementById("countdownText");
            const percent = (remainingTime / COUNTDOWN_SECONDS) * 100;
            bar.style.width = percent + "%";
            text.textContent = `${Math.ceil(remainingTime)}ç§’åè‡ªåŠ¨ä¸‹ä¸€ä¸ª`;
        }

        // ä¸‹ä¸€ä¸ªå•è¯
        function nextWord() {
            stopCountdown();
            if (state.currentWordIndex < state.words.length - 1) {
                displayWord(state.currentWordIndex + 1);
            } else {
                showResultPage();
            }
        }

        // ä¸Šä¸€ä¸ªå•è¯
        function prevWord() {
            stopCountdown();
            if (state.currentWordIndex > 0) {
                displayWord(state.currentWordIndex - 1);
            }
        }

        // é¼“åŠ±è¯­è¨€åº“
        const encouragements = [
            "ğŸ‰ å¤ªæ£’äº†ï¼ä½ å®Œæˆå¾—çœŸæ£’ï¼",
            "â­ ä½ æ˜¯ä¸ªå°å¤©æ‰ï¼ç»§ç»­åŠ æ²¹ï¼",
            "ğŸ’ª ä½ åšå¾—éå¸¸å‡ºè‰²ï¼ä¸ºè‡ªå·±éª„å‚²å§ï¼",
            "ğŸŒŸ çœŸå‰å®³ï¼ä½ è¿›æ­¥å¾—å¾ˆå¿«ï¼",
            "ğŸ˜ ä½ çš„åŠªåŠ›è¢«çœ‹åˆ°äº†ï¼ç»§ç»­åšæŒï¼",
            "ğŸŠ æ­å–œä½ ï¼ä½ å·²ç»æŒæ¡äº†è¿™äº›å•è¯ï¼",
            "âœ¨ æ£’æäº†ï¼ä½ çš„å‘éŸ³å¾ˆæ ‡å‡†ï¼",
            "ğŸ† ä½ æ˜¯æœ€æ£’çš„å­¦ä¹ è€…ï¼",
            "ğŸ’– å¥½æ£’å‘€ï¼å†åŠªåŠ›ä¸€ç‚¹å°±æ›´å®Œç¾äº†ï¼",
            "ğŸš€ ä½ åƒç«ç®­ä¸€æ ·å¿«é€Ÿè¿›æ­¥ï¼",
            "ğŸ‘ æ‹æ‹æ‰‹ï¼ä½ åšå¾—éå¸¸æ£’ï¼",
            "ğŸŒˆ ä½ å°±åƒå½©è™¹ä¸€æ ·é—ªé—ªå‘å…‰ï¼",
            "ğŸ¯ ç›®æ ‡è¾¾æˆï¼ä½ çœŸçš„å¾ˆå‰å®³ï¼",
            "ğŸ’ ä½ çš„åšæŒå¾ˆè®©äººæ„ŸåŠ¨ï¼ç»§ç»­åŠ æ²¹ï¼",
            "ğŸŒº ç¾å¥³å“¦ï¼ä½ å­¦è‹±è¯­çœŸè®¤çœŸï¼",
            "ğŸ¨ ä½ çš„å­¦ä¹ æ–¹å¼å¾ˆæœ‰åˆ›æ„ï¼",
            "âš¡ å¿«é€Ÿå­¦ä¹ è€…ï¼ä½ ååº”çœŸæ•æ·ï¼",
            "ğŸ¦‹ ä½ åƒè´è¶ä¸€æ ·ä¼˜é›…åœ°æŒæ¡äº†æ–°çŸ¥è¯†ï¼",
            "ğŸŒ™ å³ä½¿å¤©æ™šäº†ï¼Œä½ è¿˜åœ¨åŠªåŠ›ï¼çœŸå€¼å¾—èµæ‰¬ï¼",
            "â˜€ï¸ ä½ å°±åƒå¤ªé˜³ä¸€æ ·é—ªè€€ï¼ç…§äº®äº†å­¦ä¹ ä¹‹è·¯ï¼"
        ];

        // æ˜¾ç¤ºç»“æœé¡µé¢
        function showResultPage() {
            stopCountdown();
            showPage("result");

            // å°†æœ¬æ¬¡å­¦ä¹ çš„å•è¯æ ‡è®°ä¸ºå·²å­¦ä¹ 
            state.words.forEach(word => {
                markAsLearned(state.selectedUnit, word.english);
            });

            document.getElementById("totalCount").textContent = state.words.length;

            // æ¸²æŸ“å•è¯åˆ—è¡¨ï¼ˆå¸¦ä¸ä¼šæŒ‰é’®ï¼‰
            const resultList = document.getElementById("resultList");
            resultList.innerHTML = "";

            state.words.forEach((word, index) => {
                const item = document.createElement("div");
                item.className = "result-item";
                item.innerHTML = `
                    <div class="result-item-content">
                        <div class="result-english">${index + 1}. ${word.english}</div>
                        <div class="result-phonetic">${word.phonetic}</div>
                        <div class="result-chinese">${word.chinese}</div>
                    </div>
                    <button class="mark-unknown-btn" data-word="${word.english}">ä¸ä¼š</button>
                `;
                resultList.appendChild(item);
            });

            // ç»‘å®šä¸ä¼šæŒ‰é’®äº‹ä»¶
            resultList.querySelectorAll(".mark-unknown-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                    const wordEnglish = this.dataset.word;
                    if (this.classList.contains("marked")) {
                        // å–æ¶ˆæ ‡è®°ï¼Œé‡æ–°æ ‡è®°ä¸ºå·²å­¦ä¹ 
                        markAsLearned(state.selectedUnit, wordEnglish);
                        this.classList.remove("marked");
                        this.textContent = "ä¸ä¼š";
                    } else {
                        // æ ‡è®°ä¸ºä¸ä¼š
                        markAsUnknown(state.selectedUnit, wordEnglish);
                        this.classList.add("marked");
                        this.textContent = "å·²æ ‡è®°";
                    }
                });
            });

            // æ˜¾ç¤ºéšæœºé¼“åŠ±è¯­è¨€
            const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
            const resultTitle = document.querySelector(".result-title");
            resultTitle.textContent = randomEncouragement;
        }

        // è¿”å›é¦–é¡µ
        function goHome() {
            stopCountdown();
            showPage("home");
            updateProgressDisplay();
        }

        // åˆ‡æ¢é¡µé¢
        function showPage(pageName) {
            Object.values(pages).forEach(page => page.classList.remove("active"));
            pages[pageName].classList.add("active");
        }

        // å¯åŠ¨
        init();
    </script>
</body>
</html>
